<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Call Proposals Management System</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body{ background:#0f172a; color:#e2e8f0; }
  .card{ background:#111827; border-color:#1f2937; }
  .table{ color:#e5e7eb; }
  .table thead th{ color:#cbd5e1; border-bottom:1px solid #334155; }
  .table tbody td{ border-top:1px solid #1f2937; vertical-align: middle; }
  .truncate{ max-width:400px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .pill{ padding:.15rem .5rem; border-radius:9999px; font-size:.75rem; background:#1e293b; color:#93c5fd; }
</style>
</head>
<body class="py-4">
<div class="container">
  <div class="d-flex align-items-center mb-3">
    <h3 class="me-3">Call Proposals Management System</h3>
    <span id="updated" class="pill"></span>
    <div class="ms-auto">
      <button id="exportCsv" class="btn btn-primary btn-sm">Export to CSV</button>
    </div>
  </div>

  <div class="card p-3 mb-3">
    <div class="row g-2">
      <div class="col-md-5">
        <input id="q" class="form-control form-control-sm" placeholder="Search title / agency / area / eligibility..." />
      </div>
      <div class="col-md-7 d-flex align-items-center gap-3">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="fFuture">
          <label class="form-check-label" for="fFuture">Show only future deadlines</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="fIndia" checked>
          <label class="form-check-label" for="fIndia">India-related proposals only</label>
        </div>
        <span class="pill ms-auto">Total <span id="total">0</span></span>
      </div>
    </div>
  </div>

  <div class="card p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0" id="tbl">
        <thead>
          <tr>
            <th style="min-width:380px">Title</th>
            <th>Deadline</th>
            <th>Funding Agency</th>
            <th>Area</th>
            <th>Eligibility</th>
            <th>Funding/Budget (INR)</th>
            <th>Website</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
let DATA = {updated_utc:"", calls:[]};

fetch("data.json?ts="+Date.now())
  .then(r => r.json())
  .then(d => { DATA = d; init(); })
  .catch(() => { document.querySelector("#updated").innerText = "data.json not found"; });

function init(){
  document.querySelector("#updated").innerText = "Updated: " + (DATA.updated_utc || "—");
  const q = document.querySelector("#q");
  const fFuture = document.querySelector("#fFuture");
  const fIndia  = document.querySelector("#fIndia");
  const render = ()=> renderRows(filterRows(q.value, fFuture.checked, fIndia.checked));
  q.addEventListener("input", render);
  fFuture.addEventListener("change", render);
  fIndia.addEventListener("change", render);
  render();

  document.querySelector("#exportCsv").onclick = ()=>{
    const rows = filterRows(q.value, fFuture.checked, fIndia.checked);
    const csv = toCSV(rows);
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
    a.download = "calls.csv";
    a.click();
  };
}

function filterRows(query, onlyFuture, indiaOnly){
  const term = (query||"").toLowerCase();
  const today = new Date().toISOString().slice(0,10);
  return DATA.calls.filter(c=>{
    if(indiaOnly && c.india_related !== "yes") return false;
    if(onlyFuture && c.deadline && c.deadline !== "N/A" && c.deadline < today) return false;
    const hay = (c.title+" "+c.funding_agency+" "+(c.area||"")+" "+(c.eligibility||"")).toLowerCase();
    return !term || hay.includes(term);
  });
}

function renderRows(rows){
  const tbody = document.querySelector("#tbl tbody");
  tbody.innerHTML = "";
  document.querySelector("#total").innerText = rows.length;

  for(const c of rows){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="truncate" title="${esc(c.title)}">${esc(c.title)}</td>
      <td>${esc(c.deadline||"N/A")}</td>
      <td class="truncate" title="${esc(c.funding_agency)}">${esc(c.funding_agency)}</td>
      <td>${esc(c.area||"N/A")}</td>
      <td class="truncate" title="${esc(c.eligibility||"N/A")}">${esc((c.eligibility||"N/A").slice(0,80))}${(c.eligibility||"").length>80?"…":""}</td>
      <td>${esc(c.budget||"N/A")}</td>
      <td><a href="${esc(c.website)}" target="_blank" rel="noopener">Visit</a></td>`;
    tbody.appendChild(tr);
  }
}

function esc(s){ return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }

function toCSV(rows){
  const head = ["Title","Deadline","Funding Agency","Area","Eligibility","Budget","Website"];
  const lines = [head.join(",")];
  for(const c of rows){
    const arr = [c.title,c.deadline,c.funding_agency,c.area,c.eligibility,c.budget,c.website].map(v=>csvCell(v||""));
    lines.push(arr.join(","));
  }
  return lines.join("\n");
}
function csvCell(v){
  v = (""+v).replace(/"/g,'""');
  if(/[,"\n]/.test(v)) return `"${v}"`;
  return v;
}
</script>
</body>
</html>
