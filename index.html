<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Call Proposals Management System</title>
<style>
  :root {
    --bg:#0f172a; --panel:#111827; --muted:#9ca3af; --text:#e5e7eb; --accent:#2563eb; --border:#1f2937;
  }
  body{background:var(--bg); color:var(--text); font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;}
  .wrap{max-width:1100px; margin:28px auto; padding:0 16px;}
  h1{font-size:20px; margin:0 0 8px;}
  .muted{color:var(--muted); font-size:12px; margin-bottom:16px}
  .toolbar{display:flex; gap:12px; align-items:center; margin:10px 0 16px;}
  input[type="text"]{flex:1; min-width:260px; border:1px solid var(--border); background:#0b1220; color:var(--text); padding:10px 12px; border-radius:8px;}
  .pill{background:#0b1220; border:1px solid var(--border); color:var(--text); padding:8px 12px; border-radius:8px; cursor:pointer; text-decoration:none}
  table{width:100%; border-collapse:collapse; background:var(--panel); border-radius:10px; overflow:hidden}
  th,td{padding:12px 14px; border-bottom:1px solid var(--border); vertical-align:top}
  th{color:#a1a1aa; font-weight:600; background:#0b1220;}
  tr:hover td{background:#0c1426}
  .num{background:#0b1220; padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid var(--border); margin-left:6px}
  .link{color:#93c5fd; text-decoration:none}
  .nowrap{white-space:nowrap}
</style>
</head>
<body>
<div class="wrap">
  <h1>Call Proposals Management System</h1>
  <div class="muted">Updated: <span id="updated">—</span></div>

  <div class="toolbar">
    <input id="q" type="text" placeholder="Search title / agency / area / eligibility..." />
    <label><input id="future" type="checkbox" /> Show only future deadlines</label>
    <a id="csv" class="pill" href="#" download="calls.csv">Export to CSV</a>
    <span id="total" class="num">0</span>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th style="width:34%">Title</th>
        <th class="nowrap">Deadline</th>
        <th>Funding Agency</th>
        <th>Area</th>
        <th>Eligibility</th>
        <th>Funding/Budget (INR)</th>
        <th>Website</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
let DATA = [];

function fmt(d){ return (d && d !== "N/A") ? d : "N/A"; }
function isFuture(d){
  if(!d || d==="N/A") return true;
  try{
    const dt = new Date(d+"T00:00:00Z");
    const today = new Date(); today.setHours(0,0,0,0);
    return dt >= today;
  }catch(e){ return true; }
}
function matches(q, row){
  q = q.toLowerCase();
  return [row.title,row.funding_agency,row.area,row.eligibility]
    .join(" ").toLowerCase().includes(q);
}
function render(){
  const q = document.getElementById("q").value.trim();
  const futureOnly = document.getElementById("future").checked;
  const tb = document.querySelector("#tbl tbody");
  tb.innerHTML="";

  let rows = DATA;
  if(q) rows = rows.filter(r => matches(q, r));
  if(futureOnly) rows = rows.filter(r => isFuture(r.deadline));

  document.getElementById("total").textContent = rows.length;

  for(const r of rows){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${fmt(r.title)}</td>
      <td class="nowrap">${fmt(r.deadline)}</td>
      <td>${fmt(r.funding_agency)}</td>
      <td>${fmt(r.area)}</td>
      <td>${fmt(r.eligibility)}</td>
      <td>${fmt(r.budget)}</td>
      <td><a class="link" target="_blank" href="${r.website}">Visit</a></td>`;
    tb.appendChild(tr);
  }
}

function toCSV(){
  const header = ["title","deadline","funding_agency","area","eligibility","budget","website"];
  const q = document.getElementById("q").value.trim();
  const futureOnly = document.getElementById("future").checked;
  let rows = DATA;
  if(q) rows = rows.filter(r => matches(q, r));
  if(futureOnly) rows = rows.filter(r => isFuture(r.deadline));
  const lines = [header.join(",")];
  for(const r of rows){
    lines.push(header.map(k => `"${(r[k]||"").replaceAll('"','""')}"`).join(","));
  }
  const blob = new Blob([lines.join("\n")], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.getElementById("csv");
  a.href = url;
}

fetch("data.json?ts="+Date.now())
  .then(r => r.json())
  .then(j => {
    DATA = j.calls || [];
    document.getElementById("updated").textContent = j.updated_utc || "—";
    render(); toCSV();
  });

document.getElementById("q").addEventListener("input", () => { render(); toCSV(); });
document.getElementById("future").addEventListener("change", () => { render(); toCSV(); });
</script>
</body>
</html>
