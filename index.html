<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Call Proposals Management System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Nice thin scrollbar for the sidebar */
    .thin-scrollbar::-webkit-scrollbar { width: 8px; }
    .thin-scrollbar::-webkit-scrollbar-thumb {
      background: #cbd5e1; border-radius: 999px;
    }
    .thin-scrollbar { scrollbar-width: thin; scrollbar-color: #cbd5e1 transparent; }
    .tab-active { border-color: #3b82f6; color:#1f2937; }
    .tab-inactive { border-color: transparent; color:#6b7280; }
    .thead th { cursor:pointer; user-select:none; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- Header -->
  <header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex items-center gap-3">
        <div class="p-2 bg-blue-600 rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-6h13M9 7h13M5 7h.01M5 17h.01M5 12h.01"/>
          </svg>
        </div>
        <div>
          <h1 class="text-xl sm:text-2xl font-semibold">Call Proposals Management System</h1>
          <p class="text-sm text-slate-500">Filter, sort, resize, show/hide, and export funding opportunities</p>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
      <!-- Sidebar -->
      <aside class="lg:col-span-4 xl:col-span-3">
        <div class="bg-white rounded-xl shadow-sm p-4 sticky top-[92px] thin-scrollbar max-h-[calc(100vh-110px)] overflow-auto">
          <h2 class="text-base font-semibold flex items-center gap-2">
            <span class="text-blue-600">●</span> Current Calls Filters
          </h2>

          <div class="mt-4 space-y-3">
            <label class="flex items-start gap-3">
              <input id="chk-future" type="checkbox" class="mt-1 h-4 w-4 text-blue-600 rounded border-slate-300" checked />
              <span>
                <span class="font-medium">Show only future deadlines</span>
                <span class="block text-sm text-slate-500">(Current tab)</span>
              </span>
            </label>

            <label class="flex items-start gap-3">
              <input id="chk-india" type="checkbox" class="mt-1 h-4 w-4 text-blue-600 rounded border-slate-300" checked />
              <span class="font-medium">India-related proposals only</span>
            </label>

            <div>
              <label class="text-sm font-medium">Search in titles, areas, agencies, or eligibility</label>
              <input id="txt-search" type="text" class="mt-1 w-full rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500" placeholder="Type to search…" />
            </div>

            <div>
              <label class="text-sm font-medium">Filter by Area</label>
              <select id="sel-area" class="mt-1 w-full rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500"></select>
            </div>

            <div>
              <label class="text-sm font-medium">Filter by Funding Agency</label>
              <select id="sel-agency" class="mt-1 w-full rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500"></select>
            </div>

            <div>
              <label class="text-sm font-medium">Filter by Category</label>
              <select id="sel-category" class="mt-1 w-full rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500"></select>
            </div>

            <div>
              <label class="text-sm font-medium">Filter by Research Category</label>
              <select id="sel-research" class="mt-1 w-full rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500"></select>
            </div>

            <div class="pt-2">
              <button id="btn-reset" class="text-sm px-3 py-2 rounded-lg border bg-slate-50 hover:bg-slate-100">
                Reset filters
              </button>
            </div>
          </div>
        </div>
      </aside>

      <!-- Main content -->
      <section class="lg:col-span-8 xl:col-span-9">
        <!-- Tabs -->
        <div class="bg-white rounded-xl shadow-sm p-3">
          <div class="flex items-center justify-between gap-2">
            <div class="flex items-center gap-3">
              <button id="tab-current" class="px-3 py-2 border-b-2 tab-active text-sm font-medium">Current Calls</button>
              <button id="tab-recurring" class="px-3 py-2 border-b-2 tab-inactive text-sm font-medium">Recurring Annual Calls</button>
            </div>
            <div class="flex items-center gap-2">
              <button id="btn-export" class="px-3 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">
                Export to CSV
              </button>
              <div class="text-sm text-slate-500">
                Total <span id="lbl-total" class="font-semibold">0</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Table -->
        <div class="mt-4 bg-white rounded-xl shadow-sm overflow-hidden">
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-slate-100 thead">
                <tr>
                  <th data-sort="title" class="px-4 py-3 text-left font-semibold">Title</th>
                  <th data-sort="deadline" class="px-4 py-3 text-left font-semibold">Deadline</th>
                  <th data-sort="agency" class="px-4 py-3 text-left font-semibold">Funding Agency</th>
                  <th data-sort="area" class="px-4 py-3 text-left font-semibold">Area</th>
                  <th data-sort="eligibility" class="px-4 py-3 text-left font-semibold hidden md:table-cell">Eligibility</th>
                  <th data-sort="budgetINR" class="px-4 py-3 text-left font-semibold hidden lg:table-cell">Funding/Budget (INR)</th>
                  <th class="px-4 py-3 text-left font-semibold">Website Link</th>
                </tr>
              </thead>
              <tbody id="tbody" class="divide-y divide-slate-100"></tbody>
            </table>
          </div>
          <div id="empty" class="p-6 hidden">
            <p class="text-slate-500">No results. Try adjusting your filters.</p>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    // ---------- Utilities ----------
    const $ = sel => document.querySelector(sel);
    const todayStr = () => new Date().toISOString().slice(0,10);

    function parseDate(s){
      // expect YYYY-MM-DD or parseable
      if(!s) return null;
      const m = /^\d{4}-\d{2}-\d{2}$/.test(s) ? new Date(s) : new Date(Date.parse(s));
      return isNaN(m) ? null : m;
    }

    function fmtDate(s){
      const d = parseDate(s);
      if(!d) return "N/A";
      return d.toISOString().slice(0,10);
    }

    const showNA = v => (v && String(v).trim() !== "" ? v : "N/A");

    function cleanKey(s){ return (s||"").toLowerCase().replace(/[^a-z0-9]+/g," ").trim(); }
    function recordKey(r){ return cleanKey((r.title||"")+"|"+(r.agency||"")); }

    function normalize(r){
      const t = v => ((v && String(v).trim()) || "");
      return {
        title: t(r.title),
        deadline: t(r.deadline),
        agency: t(r.agency),
        area: t(r.area),
        eligibility: t(r.eligibility),
        budgetINR: t(r.budgetINR),
        url: t(r.url),
        category: t(r.category),
        researchCategory: t(r.researchCategory),
        extendedDeadline: t(r.extendedDeadline),
        country: t(r.country || "Global"),
        isRecurring: !!r.isRecurring
      }
    }

    function dedupe(list){
      const seen = new Set();
      const out = [];
      for(const r of list){
        const key = recordKey(r);
        if(!seen.has(key)){
          seen.add(key);
          out.push(r);
        }
      }
      return out;
    }

    function csvEscape(v){
      if(v == null) return "";
      const s = String(v);
      return /[,"\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }

    function toCSV(rows){
      const cols = ["title","deadline","agency","area","eligibility","budgetINR","url","category","researchCategory","extendedDeadline","country","isRecurring"];
      const header = cols.join(",");
      const lines = rows.map(r => cols.map(c => csvEscape(r[c])).join(","));
      return [header, ...lines].join("\n");
    }

    // ---------- State ----------
    let RAW = [];
    let CURRENT_TAB = "current"; // current | recurring
    let SORT = { key: "deadline", dir: "asc" };

    // ---------- UI refs ----------
    const elSearch = $("#txt-search");
    const elArea = $("#sel-area");
    const elAgency = $("#sel-agency");
    const elCategory = $("#sel-category");
    const elResearch = $("#sel-research");
    const elFuture = $("#chk-future");
    const elIndia = $("#chk-india");
    const elTotal = $("#lbl-total");
    const elTbody = $("#tbody");
    const elEmpty = $("#empty");
    const tabCurrent = $("#tab-current");
    const tabRecurring = $("#tab-recurring");

    // ---------- Data loading ----------
    const SAMPLE = [
      { title:"Centre for Advanced Research (CAR) Proposals", deadline:"2025-09-01", agency:"ICMR (Indian Council of Medical Research)", area:"Medical Research", eligibility:"Medical researchers from Indian institutes", budgetINR:"₹2,00,00,000", url:"https://www.icmr.gov.in/", category:"National", researchCategory:"Research Proposal", extendedDeadline:"", country:"India", isRecurring:false},
      { title:"SERB Core Research Grant (CRG) – Annual", deadline:"", agency:"ANRF (formerly SERB)", area:"Science & Engineering", eligibility:"Faculty researchers in Indian institutions", budgetINR:"", url:"https://www.serbonline.in/", category:"National", researchCategory:"Research Proposal", extendedDeadline:"", country:"India", isRecurring:true}
    ];

    fetch("data.json", {cache:"no-store"})
      .then(r => r.ok ? r.json() : SAMPLE)
      .then(json => {
        const src = Array.isArray(json)&&json.length ? json : SAMPLE;
        RAW = dedupe(src.map(normalize));
        initFilters(RAW);
        render();
      })
      .catch(() => {
        RAW = dedupe(SAMPLE.map(normalize));
        initFilters(RAW);
        render();
      });

    // ---------- Filters ----------
    function uniqueSorted(list, getter){
      return Array.from(new Set(list.map(getter).filter(Boolean))).sort((a,b)=> a.localeCompare(b));
    }

    function fillSelect(el, values, label){
      el.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = "";
      optAll.textContent = "All";
      el.appendChild(optAll);
      values.forEach(v=>{
        const o = document.createElement("option");
        o.value = v; o.textContent = v;
        el.appendChild(o);
      });
      el.setAttribute("data-label", label);
    }

    function initFilters(rows){
      fillSelect(elArea, uniqueSorted(rows, r=>r.area), "Area");
      fillSelect(elAgency, uniqueSorted(rows, r=>r.agency), "Agency");
      fillSelect(elCategory, uniqueSorted(rows, r=>r.category), "Category");
      fillSelect(elResearch, uniqueSorted(rows, r=>r.researchCategory), "Research");
    }

    function matchesIndia(r){
      // Prefer 'country' if present; otherwise infer from agency
      if(r.country) return r.country.toLowerCase().includes("india");
      return /(india|icmr|dbt|dst|serb|anrf|igstc|csir)/i.test(r.agency||"");
    }

    function isFuture(r){
      const d = parseDate(r.deadline);
      if(!d) return false; // treat missing as not future for "future deadlines only"
      const t = new Date(); t.setHours(0,0,0,0);
      return d >= t;
    }

    function applyFilters(){
      const search = (elSearch.value||"").toLowerCase().trim();
      const fArea = elArea.value;
      const fAgency = elAgency.value;
      const fCategory = elCategory.value;
      const fResearch = elResearch.value;

      let rows = RAW.filter(r => CURRENT_TAB === "recurring" ? r.isRecurring : !r.isRecurring);

      if(elIndia.checked) rows = rows.filter(matchesIndia);
      if(elFuture.checked && CURRENT_TAB === "current") rows = rows.filter(isFuture);

      if(search){
        rows = rows.filter(r => {
          const hay = [r.title, r.area, r.agency, r.eligibility].join(" ").toLowerCase();
          return hay.includes(search);
        });
      }
      if(fArea) rows = rows.filter(r => r.area === fArea);
      if(fAgency) rows = rows.filter(r => r.agency === fAgency);
      if(fCategory) rows = rows.filter(r => r.category === fCategory);
      if(fResearch) rows = rows.filter(r => r.researchCategory === fResearch);

      // sort
      const key = SORT.key;
      const dir = SORT.dir === "asc" ? 1 : -1;

      rows.sort((a,b)=>{
        const va = (key==="deadline") ? (parseDate(a[key]) || new Date("9999-12-31")) : (a[key]||"").toLowerCase();
        const vb = (key==="deadline") ? (parseDate(b[key]) || new Date("9999-12-31")) : (b[key]||"").toLowerCase();
        if(va<vb) return -1*dir;
        if(va>vb) return  1*dir;
        return 0;
      });

      return rows;
    }

    // ---------- Render ----------
    function render(){
      const rows = applyFilters();
      elTotal.textContent = rows.length;
      elTbody.innerHTML = "";
      elEmpty.classList.toggle("hidden", rows.length>0);

      for(const r of rows){
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td class="px-4 py-3">
            <div class="font-medium text-slate-800">${showNA(r.title)}</div>
            <div class="text-xs text-slate-400 md:hidden">${showNA(r.agency)}</div>
          </td>
          <td class="px-4 py-3">${fmtDate(r.deadline)}</td>
          <td class="px-4 py-3 hidden md:table-cell">${showNA(r.agency)}</td>
          <td class="px-4 py-3">${showNA(r.area)}</td>
          <td class="px-4 py-3 hidden md:table-cell">${showNA(r.eligibility)}</td>
          <td class="px-4 py-3 hidden lg:table-cell">${showNA(r.budgetINR)}</td>
          <td class="px-4 py-3">
            ${r.url ? `<a class="text-blue-600 hover:underline" href="${r.url}" target="_blank" rel="noopener">Visit Website</a>` : "N/A"}
          </td>
        `;
        elTbody.appendChild(tr);
      }
    }

    // ---------- Events ----------
    elSearch.addEventListener("input", render);
    [elArea, elAgency, elCategory, elResearch].forEach(el => el.addEventListener("change", render));
    elFuture.addEventListener("change", render);
    elIndia.addEventListener("change", render);
    $("#btn-reset").addEventListener("click", () => {
      elSearch.value = "";
      elArea.value = "";
      elAgency.value = "";
      elCategory.value = "";
      elResearch.value = "";
      elFuture.checked = true;
      elIndia.checked = true;
      SORT = { key: "deadline", dir: "asc" };
      render();
    });

    // Sorting by clicking table headers
    document.querySelectorAll(".thead th[data-sort]").forEach(th=>{
      th.addEventListener("click", ()=>{
        const k = th.getAttribute("data-sort");
        if(SORT.key === k){
          SORT.dir = (SORT.dir === "asc") ? "desc" : "asc";
        } else {
          SORT = { key: k, dir: "asc" };
        }
        render();
      });
    });

    // Tabs
    tabCurrent.addEventListener("click", ()=>{
      CURRENT_TAB = "current";
      tabCurrent.classList.add("tab-active"); tabCurrent.classList.remove("tab-inactive");
      tabRecurring.classList.add("tab-inactive"); tabRecurring.classList.remove("tab-active");
      // Future deadlines checkbox only meaningful for current tab
      elFuture.parentElement.classList.remove("opacity-50");
      elFuture.disabled = false;
      render();
    });
    tabRecurring.addEventListener("click", ()=>{
      CURRENT_TAB = "recurring";
      tabRecurring.classList.add("tab-active"); tabRecurring.classList.remove("tab-inactive");
      tabCurrent.classList.add("tab-inactive"); tabCurrent.classList.remove("tab-active");
      // Disable 'future only' for recurring
      elFuture.checked = false;
      elFuture.disabled = true;
      elFuture.parentElement.classList.add("opacity-50");
      render();
    });

    // Export CSV
    $("#btn-export").addEventListener("click", ()=>{
      const rows = applyFilters();
      const csv = toCSV(rows);
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "calls_export.csv";
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(url);
      a.remove();
    });
  </script>
</body>
</html>
