<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Call Proposals Management System</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <style>
    :root { --bg:#0f172a; --panel:#111827; --ink:#e5e7eb; --muted:#94a3b8; --accent:#60a5fa; }
    html,body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; background:#0b1220; color:var(--ink); }
    header { padding:18px 20px; border-bottom:1px solid #1f2937; background:var(--panel); position:sticky; top:0; z-index:10; }
    header h1 { margin:0 0 6px; font-size:20px; }
    header small { color:var(--muted); }
    main { max-width:1200px; margin: 18px auto; padding: 0 16px; }
    .bar { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:10px; }
    input[type=search] { padding:10px 12px; width:320px; border-radius:8px; border:1px solid #283446; background:#0a1424; color:var(--ink); }
    .pill { padding:8px 12px; background:#0a1424; border:1px solid #283446; border-radius:8px; color:var(--ink); }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    thead th { position:sticky; top:74px; background:#0b1220; color:#9fb3c8; text-align:left; padding:10px 8px; border-bottom:1px solid #1f2937; }
    tbody td { padding:12px 8px; border-bottom:1px solid #111827; vertical-align:top; }
    a { color:var(--accent); text-decoration:none; }
    .muted { color:var(--muted); }
    .badge { padding:2px 8px; border-radius:999px; border:1px solid #334155; background:#0a1424; color:#9fb3c8; font-size:12px; }
    .count { margin-left:auto; color:#9fb3c8; }
    .nowrap { white-space:nowrap; }
  </style>
</head>
<body>
  <header>
    <h1>Call Proposals Management System</h1>
    <small id="ts" class="muted"></small>
  </header>

  <main>
    <div class="bar">
      <input id="q" type="search" placeholder="Search title, agency, area, eligibilityâ€¦"/>
      <label class="pill"><input id="ind" type="checkbox" />&nbsp; India-related only</label>
      <span class="count"><span id="n">0</span> results</span>
    </div>

    <div class="pill" style="margin-bottom:10px;">
      Columns: &nbsp;
      <label><input type="checkbox" class="col" data-col="area" checked> Area</label>&nbsp;&nbsp;
      <label><input type="checkbox" class="col" data-col="eligibility" checked> Eligibility</label>&nbsp;&nbsp;
      <label><input type="checkbox" class="col" data-col="budget" checked> Funding/Budget</label>
    </div>

    <table id="t">
      <thead>
        <tr>
          <th>Title</th>
          <th class="nowrap">Deadline</th>
          <th>Funding Agency</th>
          <th class="col-area">Area</th>
          <th class="col-eligibility">Eligibility</th>
          <th class="col-budget nowrap">Funding/Budget</th>
          <th>Website</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

<script>
(async function () {
  const res = await fetch('data.json', {cache:'no-store'});
  const data = await res.json().catch(_ => ({updated_utc:'', calls:[]}));
  document.getElementById('ts').textContent = data.updated_utc ? ('Updated: ' + data.updated_utc) : '';

  const tbody = document.querySelector('#t tbody');
  const q = document.getElementById('q');
  const ind = document.getElementById('ind');
  const n = document.getElementById('n');
  const toggles = document.querySelectorAll('.col');

  function row(c) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><div>${escapeHtml(c.title || 'N/A')}</div></td>
      <td class="nowrap">${escapeHtml(c.deadline || 'N/A')}</td>
      <td>${escapeHtml(c.funding_agency || 'N/A')}</td>
      <td class="col-area">${escapeHtml(c.area || 'N/A')}</td>
      <td class="col-eligibility">${escapeHtml(c.eligibility || 'N/A')}</td>
      <td class="col-budget">${escapeHtml(c.budget || 'N/A')}</td>
      <td>${c.website ? `<a href="${c.website}" target="_blank" rel="noopener">Visit</a>` : 'N/A'}</td>`;
    return tr;
  }

  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  const calls = data.calls || [];

  function apply() {
    const qv = (q.value || '').toLowerCase();
    const onlyIN = ind.checked;

    tbody.innerHTML = '';
    let count = 0;
    for (const c of calls) {
      if (onlyIN && (c.india_related !== 'yes')) continue;
      const hay = (c.title + ' ' + c.funding_agency + ' ' + (c.area||'') + ' ' + (c.eligibility||'')).toLowerCase();
      if (qv && !hay.includes(qv)) continue;
      tbody.appendChild(row(c));
      count++;
    }
    n.textContent = count;
  }

  toggles.forEach(chk => {
    chk.addEventListener('change', () => {
      const col = chk.dataset.col;
      document.querySelectorAll('.col-'+col).forEach(el => {
        el.style.display = chk.checked ? '' : 'none';
      });
    });
    // initial
    document.querySelectorAll('.col-'+chk.dataset.col).forEach(el => {
      el.style.display = chk.checked ? '' : 'none';
    });
  });

  q.addEventListener('input', apply);
  ind.addEventListener('change', apply);
  apply();
})();
</script>
</body>
</html>
